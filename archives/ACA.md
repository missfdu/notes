# Aliyun ACA

## 阿里云简介

### 云计算概念

优势：灵活，成本

部署模式：

- 公有云
- 专有云
- 混合云

服务模式：

- IaaS
- PaaS
- SaaS
- Daas

### 阿里云发展历程

- 2009 成立
- 2013 世界第一个提供 5K 云计算能力
- 2014 国内第一个出海

### 阿里云产品全家福

- 弹性计算
  - ECS
  - 弹性裸金属服务器(神龙)
    - 兼具虚拟机的弹性和物理机的高性能
  - 超级计算集群
    - RDMA 远程内存直接访问
  - 弹性伸缩
- 存储服务
  - 对象存储 OSS
  - 块存储 eg.硬盘
  - 文件存储 NAS
    - 支持NFS、CIFS
  - 云存储网关
    - 可在线下和云上部署的软网关
  - 混合云存储阵列
- 网络
  - 专有网络 VPC
  - 负载均衡 SLB
  - NAT 网关
  - 弹性公网 IP
  - 云企业网
    - 多地多部门互联
  - VPN 网关
    - 安全加密的云上云下数据互通
- 数据库
  - 云数据库 PolarDB
  - 云数据库 RDS MySQL版
  - 数据传输服务 DTS
  - 数据管理 DMS
    - 比 phpMyAdmin强大，比 Navicat 易用
- CDN 与边缘
- 安全
  - DDoS 高防 IP
  - Web 应用防火墙
  - 云防火墙
  - 云安全中心

### 阿里云产品架构

略

### 阿里云基础架构

地域(Region)：基于地理位置划分，创建成功后不能修改，不同地域提供的阿里云资源会略有不同。不同地域间互联通过公网，需收费。

可用区(Zone)：同一地域内，电力和网络互相独立的物理区域。同一地域内不同可用区处于内网中。

地域考虑因素：

- 地理位置：目标用户所在
- 阿里云产品间的关系
- 经营许可证备案
- 价格

多可用区部署，提高容灾能力，延时略提升

## 弹性计算

### 概念

架构图

管理员入口：控制台，API等

访问设备：ECS

实例：metadata, userdata, 系统事件

镜像：为实例提供运行时环境

块存储：为实例提供数据存储

快照：为块存储备份，也可作为镜像的基础数据

部署建议

- 地域和可用区
- 高可用性
- 网络规划
- 安全方案

使用场景

- 企业官网或轻量Web应用
- 多媒体及高并发
- 高 I/O
- 访问量波动剧烈
- 大数据、AI等

### 优势

稳定：单实例可用性 < 多可用区多实例可用性 < 云盘可靠性

高性能：单实例最高 88vCPU，704GB内存，700万PPS网络收发包，35Gbps带宽

易用性、安全性、灵活性：云服务器 ECS > 普通 IDS

### 实例规格

系统盘

生命周期：

- 创建
- 准备中 Pending
- 启动中 Starting
- 运行中 Running
- 停止中 Stopping
- 已停止 Stopped
- 删除

规格族

- 通用 g系列
- 计算 c系列
- 内存 r系列
- 大数据 d系列
- 本地SSD i系列

### 弹性裸金属服务器（神龙）EBM

融合物理机性能与云服务器弹性优势，无虚拟化开销

支持嵌套虚拟化

优势

- 用户独占计算资源
- 加密计算
- 兼容多种专有云
- 异构指令集处理器支持

适用场景

- 游戏
- SCC 超级计算
- 金融加密

### 使用

创建流程

- 基础配置
- 网络与安全组
- 系统配置

镜像类型

- 公共镜像
- 自定义镜像：使用实例或快照创建的镜像
  - 费用为对应快照容量费用
- 共享镜像
- 镜像市场

连接方式：除 VNC 外，均要求待连接实例分配了固定公网IP或EIP

重置密码：无需重置系统，必须处于稳定状态，重启后生效

## 存储

常见存储结构

- 块存储：需要分区格式化才能使用，以数据块为存储单元
  - 在线存储，可信度高，通用
  - 成本高，跨平台不方便
  - 常见：
    - 直接访问存储 DAS
    - 存储区域网络 SAN
      - 多节点读写，集群
- 文件存储：由文件存储服务器 NAS 提供文件访问服务，以文件为存储单位
  - 近线存储，适合存放资料
  - 常见：CIS、NFS等
- 对象存储：扁平化结构，以对象为存储单位
  - 无层次，扩展性好，执行效率高

### OSS概念

存储类型 Storage Class

- 标准
- 低频访问
- 归档

存储空间 Bucket：用于存储对象的容器，所有对象都必须隶属于某个存储空间

对象 Object：OSS存储数据的基本单元，由元信息(Object Meta)、用户数据(Data)和文件名(Key)组成

地域 Region

访问域名 Endpoint：OSS对外服务的访问域名

访问密钥 AccessKey：简称AK，指访问身份验证中用到的AccessKey Id 和 AccessKey Secret

### OSS优势和使用场景

优势

- 方便快捷的使用方式
  - 丰富的API接口、SDK包
  - 存储空间大小无限制
  - 数据生命周期管理
- 强大灵活的安全机制
  - 鉴权，授权机制
  - 用户级别资源隔离机制和多集群同步机制
- 丰富强大的增值服务
  - 图片音视频处理
  - 内容加速分发
- 数据冗余机制
  - 操作具有强一致性

相比自建对象存储的优势
- 可靠性
- 安全
- 成本
- 智能存储

### OSS使用

流程

- 开通 OSS 服务
- 创建存储空间 Bucket
  - 名称全网唯一且无法更改
  - 区域无法更改，ECS访问需相同区域
  - 存储类型无法更改
  - 同城冗余存储，冗余存储在三个可用区中，开启后无法关闭
- 上传文件
  - 与原有文件重名会覆盖
- 下载文件
- 删除文件
- 删除存储空间

### 块存储概念

指标

- IOPS
- Latency

### 块存储分类

云盘和本地盘

云盘的类型

- ESSD
- SSD
- 高效云盘
- 普通云盘

云盘的数据类型
- 系统盘
   - 只能随实例创建，生命周期与实例相同
   - 单台实例上限为1
- 数据盘
   - 可单独创建
   - 单台实例上限为16

**云盘只能挂载到同一可用区的实例**

### 块存储 VS 对象存储

| 对比项   | 块存储                                                       | OSS                                       |
| -------- | ------------------------------------------------------------ | ----------------------------------------- |
| 数据模型 | 树状索引结构的文件系统                                       | 分布式 Key-Value 对象存储服务             |
| 数据获取 | 先访问目录，再查找文件                                       | 根据对象(Object)的名称(Key)唯一获取其内容 |
| 优势     | 支持文件修改和文件夹操作                                     | 支持海量用户并发访问                      |
| 劣势     | 受限于单个设备性能，目录越深消耗资源越大，操作文件多的目录速度慢 | Object 不支持修改，需要重新上传整个目录   |

### 块存储使用

- ECS 不支持单独创建系统盘
- 数据盘只能挂载同一可用区的 ECS
- 不支持合并多块云盘，提前做好数量和容量规划
- 已创建的多块云盘不建议 LVM
  - 快照是对单个云盘进行，避免与 LVM 一同使用
- 被挂载的实例的状态稳定，云盘的状态为待挂载(Available)
- 分区格式化支持 MBR 和 GPT

## 网络

### VPC概念

Virtual Private Cloud

提供两个能力：

- 用户可以自定义网络拓扑，选择自由 IP 地址范围、划分网段、配置路由表和网关等
- 通过专线或 VPN 与原有数据中心连接，云上和云下的资源使用同一个网络地址规划，实现应用的平滑迁移上云

VPC 组成：一个路由器、至少一个交换机和至少一个私网网段

- VRouter：VPC 的枢纽
- VSwitch：组成 VPC 的基础网络设备
- 私网网段：创建 VPC和交换机时，需要以 CIDR 地址块的形式指定 VPC 使用的私网网段

### VPC连接

| 产品        | 功能                                                         | 优势                                                         |
| ----------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 固定公网IP  | 创建ECS实例时可选分配一个支持访问公网和被公网访问的IP地址    | 支持使用共享流量包，可转换为EIP                              |
| 弹性公网EIP | 动态和ECS实例绑定和解绑，支持访问公网和被公网访问            | 随时和ECS绑定/解绑                                           |
| NAT网关     | 支持多台ECS实例访问公网和被公网访问                          | 可用于多台ECS实例和公网通信                                  |
| 负载均衡    | 基于端口提供四层和七层负载均衡功能，支持用户从公网通过SLB访问ECS | 一个负载均衡的一个端口可对应多台ECS，扩展应用系统对外服务能力 |

SNAT访问公网，DNAT被公网访问

本地IDC上云

- 高速通道
  - 物理专线接入
  - 骨干网络，延迟低，贵
- VPN网关
  - IPSec-VPN 将本地IDC网络和云上VPC连接
  - SSL-VPN  将本地**客户端**远程接入VPC
  - 低成本，配置简单
- 云企业网
  - 一网
  - 跨地域VPC需收取费用
- 智能接入网关
  - 物理设备，即插即用
  - 配置自动化，网络拓扑变化自适应快

### VPC基础架构

逻辑架构：**交换机**和**网关**完成**数据通路**的关键路径，**控制器**完成**配置通路**的关键路径

网络规划：

- 单地域只需单VPC，多地域必须多VPC，业务隔离必须多VPC
- 一个VPC尽量使用多个交换机且分布在不同可用区，实现跨可用区容灾
- 交换机的网段必须是所属VPC网段的子集，注意VPC网段之间避免重叠

### SLB概念

Server Load Balance 是将访问流量根据转发策略分发到后端多台云服务器的流量分发控制服务

- 通过设置虚拟服务地址，将同一地域的多台ECS实例虚拟成一个高性能、高可用的后端服务池
- 默认检查ECS实例的健康状态，自动隔离异常状态的ECS实例

组成部分

- 负载均衡实例 Server Load Balacnce Instances
  - 一个运行的SLB服务，接收流量并将其分配给后端服务器
- 监听 Lisenter
  - 检查客户端请求并将其转发给后端服务器
  - 对后端服务器进行健康检查
- 后端服务器
  - 一组接受前端请求的ECS实例
  - 数据要一致

优势

- 高可用
  - 全冗余设计，无单点
  - 同城容灾
  - 搭配DNS后才可实现跨地域容灾
- 可扩展
- 低成本
- 安全
  - 结合云盾，5Gbps的DDoS防御能力
- 高并发
  - 集群实现亿级并发访问能力

### SLB原理

基础架构：

- 四层(到传输层TCP和UDP)
  - 采用Tengine实现SLB
- 七层(到应用层HTTP和HTTPS)
  - 采用LVS(Linux Virtual Server) + keepalived实现SLB

常用功能

- **调度算法**
  - 轮询
  - 加权轮询 WRR
  - 加权最小连接数 WLC
  - 一致性哈希 CH
- 健康检查
- 会话保持
- 访问控制
  - 黑白名单
- 高可用
  - 将流量转发给多个可用区的后端服务器
- 安全防护

应用场景

- 高访问量业务
- 扩展应用程序
- 消除单点故障
- 同城多可用区容灾
- 跨地域容灾
  - 在不同地域分别部署SLB实例，上层利用云解析做智能DNS

### SLB配置

- 创建SLB实例
- 添加监听
- 添加后端服务器
- 域名解析(可选)

地域：

- 离客户近
- 提供主备可用区
- 与后端ECS实例相同

网络类型：公网 or 私网

协议类型：

- 四层监听将请求直接转发给后端服务器，不修改标头
- 七层监听原理上是反向代理的一种实现

### AS 弹性伸缩

弹性伸缩Auto Scaling，根据业务需求和策略设置伸缩规则，需求增长/减少时自动增加/减少ECS实例以保证计算能力/节约成本

完整的AS服务需要SLB提供负载均衡。(AS其实只是调整服务器数量，和网络无关？因为通常要结合SLB所以放在本章)

功能限制

- 不支持纵向扩展，即升降配，只能增加或减少数量
- ECS实例上的应用必须无状态且可横向扩展
- 伸缩组内ECS实例可能被自动释放，不适合保存重要数据
- 不支持自动将ECS实例添加到Memcache实例的访问白名单

使用场景

- 弹性扩张
- 弹性收缩
- 弹性自愈
  - 自动监控伸缩组内ECS实例的健康状态

使用流程

- 创建伸缩组和伸缩配置
- 创建伸缩规则
- 创建定时任务/报警任务

**伸缩模式**

- 定时模式
- 动态模式
  - 基于云监控性能指标，如CPU利用率
- 固定数量模式
  - 设置最小实例数
- 自定义模式
- 健康模式
- 多模式并行

## 数据库

### PolarDB概念

集群：一个集群包含一个主节点以及1~15个只读节点

节点：一个独立占用物理内存的数据库服务进程，节点ID以pi开头

数据库：在节点下创建的逻辑单元，一个节点可以创建多个数据库，数据库在节点内的命名唯一

### PolarDB优势

- 下一代关系型云数据库
- 三个独立引擎分别
  - 完全兼容MySQL
  - 完全兼容PostgreSQL
  - 高度兼容Oracle
- 容量最高达100TB
- 单库最多扩展16个节点
- 集群架构，存储和计算分离，所有计算节点共享一份数据
- 读一致性
- 无锁备份
- 分钟级弹性，毫秒级延时(物理复制)

### RDS概念

- 实例
- 数据库引擎
- 网络类型

RDS VS 自建数据库

- 易用性
- 性能
- 安全
  - 事前防护
  - 事中保护
  - 事后审计

### RDS产品选型

产品

- 基础版
  - 单节点实例
- 高可用版
  - 一主一备的经典高可用架构
- 集群版
  - 仅SQL Server提供
  - 基于AlwaysOn技术实现
- 三节点企业版(原金融版)
  - 仅MySQL提供
  - 一主两备

规格族

- 共享型
  - 有资源争抢风险
- 通用型
  - CPU资源轻微复用
- 独享型
  - 具有完全独享的CPU和内存，不会受其他实例的影响
  - 独占物理机型
    - 是最顶配
    - 完全独占的物理机

存储类型

- 本地SSD
- SSD云盘
- ESSD云盘

不管哪种存储类型，可靠性、持久性和读写性能均满足产品SLA承诺

### PolarDB使用流程

- 创建数据库集群
- 设置集群白名单
- 创建数据库帐号
  - 高权限帐号
    - 只能通过控制台创建和管理
    - 一个集群只能有一个
  - 普通帐号
    - 可通过控制台或SQL语句创建
    - 一个集群可有多个
- 查看连接地址
  - **集群地址**
    - 读写分离，写请求自动发往主节点，读请求根据各节点负载
  - 主地址
    - 总是连主节点（除非主节点故障）
- 连接数据库集群

数据迁移/同步：阿里云数据传输服务DTS

数据迁移的类型：

- 结构对象迁移
- 全量数据迁移
- 增量迁移

数据同步：实现两个数据源之间的增量数据实时同步

## CDN

指标

- 延时
- 下载速度
- 打开速度
- 丢包率
- 回源率
  - 回源请求数比例
    - 没有缓存、缓存过期和不可缓存的请求占全部请求的比例
  - 回源流量比
  - 越低越好
- 缓存命中率
  - 越高越好

名词

- CNAME记录
  - CNAME即别名，把一个域名解析到另一个域名
- CNAME域名
  - 接入CDN，在控制台添加加速域名后，阿里云CDN将分配一个CNAME域名
  - 需要自行修改CNAME记录 
- 边缘节点
- 源站
- 回源

场景

- 静态内容加速：阿里云CDN
- 动态内容加速：阿里云全站加速
- 安全加速：阿里云安全加速

## 云上安全防护

云计算安全风险

- 数据丢失或泄露
- 系统和技术漏洞
- 帐号与身份管理不善
- 数据集中的安全问题
- API安全存疑，DoS攻击泛滥

共建安全

- 用户负责上层业务
  - 业务数据
  - 应用系统
  - ECS
- 阿里云负责基础设施
  - 物理资源
  - 资源抽象

安全产品体系

- 云盾

- 云产品安全

  - 数据安全
    - 快照
    - 销毁
    - 加密
  - 应用安全
    - 安全开发生命周期SDL
  - 主机安全
  - 网络安全

  WAF

  - DNS配置
  - 透明代理

  云安全中心

  - 基础版
    - 默认免费开通
  - 基础杀毒版
  - 高级版
  - 企业版